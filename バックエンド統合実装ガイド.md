# Echo アプリ バックエンド統合実装ガイド

このガイドでは、バックエンド統合のための実装手順と注意点を説明します。今回の実装で主要な予約とレビュー機能の統合が完了しました。

## 1. 実装したファイル

今回の実装で追加・更新した主要なファイルは以下の通りです：

### フロントエンド

1. **services/BookingService.ts**
   - 予約関連の機能を集約したサービス
   - 予約の作成、取得、更新、キャンセル、確定などの機能を提供

2. **services/ReviewService.ts**
   - レビュー関連の機能を集約したサービス
   - レビューの投稿、取得、編集、削除、「役に立った」マーキングなどの機能を提供

3. **src/utils/apiClient.ts (既存)**
   - Firebase Authentication統合機能付きAPIクライアント
   - 認証トークンを自動的にAPIリクエストヘッダーに追加
   - トークンキャッシュ機能とリフレッシュ機能

### バックエンド

1. **echo-backend/src/middleware/authMiddleware.ts**
   - バックエンド側でのFirebase認証ミドルウェア
   - トークン検証、ロールベースアクセス制御、アテンダー検証などの機能を提供

2. **echo-backend/src/middleware/errorMiddleware.ts**
   - グローバルエラーハンドリングミドルウェア
   - 標準化されたAPIエラーレスポンスの提供

3. **echo-backend/src/routes/reviews.ts**
   - レビュー管理APIのエンドポイント実装
   - レビューの作成、取得、更新、削除、「役に立った」マーク追加などの機能

4. **echo-backend/src/routes/bookings.ts**
   - 予約管理APIのエンドポイント実装
   - 予約の作成、取得、ステータス更新などの機能

5. **echo-backend/src/app.ts**
   - バックエンドアプリケーションのメイン設定
   - ミドルウェアの設定、ルートの登録

6. **echo-backend/src/server.ts**
   - サーバー起動スクリプト

## 2. 統合手順

### 2.1 フロントエンド側の統合

1. **APIクライアントの利用**

```typescript
// 既存のAPIクライアントを利用
import api, { logApiRequest, logApiResponse } from '../src/utils/apiClient';
```

2. **サービスの使用**

```typescript
// サービスを必要な場所でインポート
import { getUserBookings, createBooking } from '../services/BookingService';
import { getAttenderReviews, createReview } from '../services/ReviewService';
```

3. **認証情報の取得**

```typescript
// 認証情報を取得
import { getAuth } from 'firebase/auth';

// ユーザーIDの取得
const auth = getAuth();
const user = auth.currentUser;
const userId = user?.uid;
```

### 2.2 バックエンド側の統合

1. **認証ミドルウェアの統合**

`echo-backend/src/routes/index.ts` で認証ミドルウェアを適用：

```typescript
// 認証が必要なルートに適用
router.use('/attenders', verifyAuth);
router.use('/bookings', verifyAuth);
router.use('/reviews', verifyAuth);

// 特定のエンドポイントに役割制限を適用
router.use('/admin', verifyAuth, requireRoles(['admin']));

// アテンダー専用ルートに検証を適用
router.use('/attenders/:id/experiences', verifyAuth, verifyAttender);
```

2. **ルーターの統合**

作成したルーターを `index.ts` ファイルにマウント：

```typescript
// ルーターをマウント
router.use('/bookings', bookingRoutes);
router.use('/reviews', reviewRoutes);
```

3. **エラーハンドリングの統合**

`app.ts` でグローバルエラーハンドラーを設定：

```typescript
// 404ハンドラー
app.use(notFoundHandler);

// グローバルエラーハンドラー
app.use(globalErrorHandler);
```

## 3. 主要なデータフロー

### 3.1 予約作成プロセス

1. ユーザーが予約フォームを送信
2. `BookingService.createBooking()` がフォームデータを受け取る
3. Firebase Authentication から現在のユーザーIDを取得
4. バックエンドAPIにデータを送信（認証トークン付き）
5. バックエンドでトークンを検証し、ユーザーIDを確認
6. Firestoreに予約データを保存
7. 関連するユーザーへの通知を作成
8. 成功レスポンスをフロントエンドに返す

### 3.2 レビュー投稿プロセス

1. ユーザーがレビューフォームを送信
2. `ReviewService.createReview()` がフォームデータを受け取る
3. Firebase Authentication から現在のユーザーIDを取得
4. バックエンドAPIにデータを送信（認証トークン付き）
5. バックエンドでトークンを検証し、ユーザーIDを確認
6. Firestoreにレビューデータを保存
7. アテンダーの評価平均を更新
8. 成功レスポンスをフロントエンドに返す

## 4. 認証データフロー

1. ユーザーがログイン
2. Firebase Authentication からIDトークンを取得
3. `apiClient.ts` がトークンをキャッシュし、リクエストヘッダーに追加
4. バックエンドAPIがリクエストを受信
5. `authMiddleware.ts` がトークンを検証
6. 検証成功時、リクエストオブジェクトにユーザー情報を追加
7. APIハンドラーが処理を続行

## 5. 注意点とベストプラクティス

### 5.1 セキュリティ

- 認証トークンは常にHTTPS接続で送信する
- Firebaseのセキュリティルールを適切に設定する
- バックエンド側でもユーザーIDの所有権を検証する（自分のリソースのみアクセス可能に）
- 権限チェックを確実に実施する：
  - 特に重要な操作（アテンダー専用操作など）
  - リソース所有権の確認（自分のレビュー/予約のみ編集/削除可能）

### 5.2 エラーハンドリング

- クライアント側でのエラーハンドリングを強化する
- ユーザーフレンドリーなエラーメッセージを表示
- 開発環境での詳細なログ出力
- エラーの種類に応じた適切な処理：
  - ネットワークエラー
  - 認証エラー
  - バリデーションエラー
  - サーバーエラー

### 5.3 パフォーマンス

- トークンキャッシュを活用して不要なリクエストを減らす
- 大きなデータセットには適切なページネーションを実装
- レスポンスのキャッシュ戦略を検討
- 不要なデータの取得を避ける（関連データの適切なプロジェクション）

## 6. 次のステップ

1. **アテンダーAPIの実装**
   - アテンダー登録、検索、詳細表示
   - アテンダープロフィール管理

2. **ユーザーAPIの実装**
   - ユーザープロフィール管理
   - 設定管理

3. **通知システムの強化**
   - プッシュ通知（Firebase Cloud Messaging）
   - メール通知
   - 通知設定の管理

4. **ファイルアップロード機能**
   - プロフィール画像
   - レビュー画像
   - 体験関連画像

5. **決済システムの統合**
   - 決済プロバイダーとの連携
   - 決済履歴管理
   - 返金処理

## 7. テスト方法

1. **認証テスト**
   - ログイン後のトークン取得テスト
   - 認証ヘッダー付きリクエストのテスト
   - 権限不足時のエラー処理テスト

2. **予約テスト**
   - 予約作成の成功シナリオ
   - バリデーションエラーのテスト
   - 予約状態変更のテスト（確定、キャンセル、完了）

3. **レビューテスト**
   - レビュー投稿の成功シナリオ
   - レビュー編集・削除のテスト
   - 「役に立った」機能のテスト

各テストは開発環境でモックデータを使用して実行可能です。本番環境前にはFirebase Emulatorを使用した統合テストを行うことをお勧めします。

## 8. デプロイ準備

1. **環境変数の設定**
   - 開発環境と本番環境の分離
   - 機密情報の適切な管理

2. **ビルドとパッケージング**
   - バックエンドのビルド
   - フロントエンドのビルド
   - 静的アセットの最適化

3. **デプロイ戦略**
   - バックエンド：Cloud Functionsまたは独自サーバー
   - フロントエンド：Firebase Hostingまたは別のホスティングサービス
   - データベース：Firebase Firestore

4. **モニタリングと分析**
   - エラー追跡
   - パフォーマンスモニタリング
   - ユーザー行動分析

## 9. 今後の最適化

1. **コード品質の向上**
   - ユニットテストの充実
   - コードドキュメントの強化

2. **パフォーマンス最適化**
   - クエリの効率化
   - キャッシュ戦略の導入

3. **スケーリング対策**
   - 負荷分散戦略
   - データベースインデックスの最適化

4. **ユーザーエクスペリエンスの向上**
   - オフライン機能の強化
   - リアルタイム更新

このガイドに従って実装を進めることで、Echo アプリのバックエンド統合を効率的に進めることができます。
