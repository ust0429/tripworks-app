# バックエンド開発および環境構築計画 (2025-03-27)

## 概要
echoアプリのバックエンド開発および環境構築計画を詳細化しました。現在はGitHubのプレビューサーバーでフロントエンド開発を進めていますが、バックエンド機能の強化とAPIの本格的な実装に向けて、Google Cloud Platform (GCP) と Firebase を組み合わせたハイブリッドな環境構築を行います。

## APIクライアントの開発状況

### 実装済みのファイル
- `src/api/cloudRunClient.ts` - Cloud Run APIクライアントの基盤
- `src/api/cloudRunConfig.ts` - APIエンドポイントや環境設定
- `src/api/services/attenderService.ts` - アテンダー関連のAPIサービス
- `src/hooks/api/useCloudRunApi.ts` - React Queryを使用したAPIフック

### 実装の詳細

1. **CloudRunClientの実装**
   - RESTful APIリクエストの基本処理を実装
   - GET, POST, PUT, DELETEメソッドの実装
   - ファイルアップロード機能の実装
   - タイムアウト処理とエラーハンドリングの実装

2. **APIエンドポイントの設定**
   - ローカル開発環境、ステージング環境、本番環境の切り替え機能
   - 主要リソース（アテンダー、体験、レビュー、予約など）のエンドポイント定義

3. **AttenderServiceの実装**
   - アテンダー一覧取得、詳細取得、作成、更新、削除などの基本メソッドの実装
   - アテンダー検索とフィルタリング機能
   - プロフィール画像アップロード機能
   - アテンダーの体験一覧取得メソッド

4. **React Queryを使用したAPIフックの実装**
   - useApiQuery - GETリクエスト用フック
   - useApiMutation - POSTリクエスト用フック
   - useApiPutMutation - PUTリクエスト用フック
   - useApiDeleteMutation - DELETEリクエスト用フック
   - useApiUploadMutation - ファイルアップロード用フック
   - リソース別のフック（useAttenders, useExperiencesなど）

### 次の開発予定

1. **ExperienceServiceの実装完了**
   - 体験リソースの詳細実装
   - 検索やフィルタリングの強化

2. **ReviewServiceの実装**
   - レビューの投稿、取得、運用機能
   - レビュー画像の管理

3. **BookingServiceの実装**
   - 予約作成、取得、更新、キャンセル機能
   - 予約状態管理

4. **本番環境に向けた調整**
   - 適切なエラーハンドリングの実装
   - キャッシュ戦略の最適化
   - パフォーマンスメトリクスの収集

### 当面の課題
1. APIレスポンスのキャッシュ戦略が未定義
2. エラー処理の標準化が必要
3. テストカバレッジの向上が必要
4. APIタイムアウト設定の最適化

### 気づき点と推奨事項
1. React Queryの標準的なエラー処理パターンが必要
2. 特に画像アップロード時の使い勝手の改善が必要
3. APIリクエストのログ出力とトラッキングの強化
4. 不正アクセスからのAPI保護の仕組みを導入すべき

## 選定した環境
**Google Cloud Platform (GCP) + Firebase**

### 選定理由
- Firebase との完全統合が可能（既存のFirebaseリソースとの連携が容易）
- 段階的な移行が可能（フロントエンド開発を継続しながらバックエンド機能を強化）
- コスト効率が良い（無料枠も比較的寛大）
- 開発チームの学習コストが最小限

## 実装計画

### ステップ1: GCP プロジェクトのセットアップ
- GCPプロジェクト作成と既存Firebaseプロジェクトの接続
- 必要なAPIの有効化（Cloud Run, Container Registry, Cloud Build等）
- Firebase連携の確認と設定
- サービスアカウントの設定とキーの作成

### ステップ2: バックエンドAPIの開発とCloud Runへのデプロイ
- Node.js/Express APIプロジェクトの設定
- Dockerファイルの作成とコンテナ化
- アプリケーションのビルドとローカルテスト
- Cloud Runへのデプロイ

### ステップ3: CI/CDパイプラインの構築
- GitHub Actions用のワークフロー設定
- GitHub Secretsの設定
- テスト・ビルド・デプロイの自動化

### ステップ4: ステージング環境での検証
- フロントエンドの環境変数設定
- APIとの連携テスト
- エラーハンドリングの検証

### ステップ5: 本番環境への段階的移行
- 本番環境の設定
- 本番用CI/CDワークフロー設定
- 段階的な機能移行
- モニタリングとログの設定

## バックエンド開発の優先機能
1. アテンダーAPI（一覧取得、詳細取得、登録、更新）
2. ユーザープロフィールAPI
3. 予約管理API
4. レビューAPI
5. 支払い連携API
6. 通知システム

## 技術スタック（バックエンド）
- **サーバー**: Node.js, Express, TypeScript
- **データベース**: Firebase Firestore（既存）
- **コンテナ**: Docker
- **CI/CD**: GitHub Actions
- **実行環境**: Google Cloud Run
- **監視**: Cloud Monitoring, Error Reporting
- **認証**: Firebase Authentication（既存）
- **ストレージ**: Firebase Storage（既存）, Google Cloud Storage

## スケジュール
- ステップ1-2: 1週間（2025-03-28 〜 2025-04-03）
- ステップ3-4: 1週間（2025-04-04 〜 2025-04-10）
- ステップ5: 2週間（2025-04-11 〜 2025-04-24）
- アテンダーAPI開発: 1週間（2025-04-11 〜 2025-04-17）
- ユーザープロフィールAPI開発: 1週間（2025-04-18 〜 2025-04-24）
- 予約管理API開発: 1週間（2025-04-25 〜 2025-05-01）

## 注意点
- フロントエンド開発は引き続きGitHubプレビュー環境で並行して進める
- バックエンドAPIの変更は、フロントエンドとの連携を常に確認しながら進める
- セキュリティを常に意識し、APIキーなどの秘密情報は環境変数や Secret Manager で管理
- コスト管理のため、適切なインスタンスサイズや自動スケーリングの設定を行う