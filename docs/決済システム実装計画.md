# Echo アプリ 決済システム実装計画

## 概要

Echo アプリに決済システムを統合し、ユーザーが体験予約の支払いやアテンダーへの報酬支払いを安全かつ便利に行えるようにします。本計画では、決済システムの設計、実装方針、および統合方法について詳細を説明します。

## 決済システムの要件

### 基本要件

1. **安全な決済処理**
   - クレジットカード情報の安全な取り扱い
   - 国際標準のセキュリティ対応（PCI DSS準拠）
   - 不正利用検知と防止

2. **多様な決済方法**
   - クレジットカード（Visa, Mastercard, JCB, etc.）
   - コンビニ決済
   - 銀行振込
   - 電子マネー（PayPay, LINE Pay, etc.）

3. **取引管理**
   - 決済履歴の表示
   - 返金処理
   - 領収書の発行

4. **アテンダー報酬管理**
   - 収益計算
   - 出金リクエスト
   - 支払い状況追跡

### 技術要件

1. **サードパーティ決済プロバイダー連携**
   - Stripe の利用
   - API 連携の実装
   - Webhook 処理

2. **セキュリティ対策**
   - トークン化による決済情報の保護
   - ユーザー認証と承認
   - 暗号化通信

3. **エラーハンドリング**
   - 決済失敗時の対応
   - リトライメカニズム
   - エラー通知

4. **パフォーマンス**
   - 応答時間の最適化
   - 同時処理能力の確保

## 技術選定

### 決済プロバイダー

**Stripe を採用する理由:**

1. **開発者フレンドリーな API**
   - 豊富なドキュメントと実装例
   - シンプルで使いやすい SDK

2. **セキュリティ機能**
   - PCI DSS レベル 1 認定
   - 不正検出システム
   - 決済情報のトークン化

3. **国際対応**
   - 複数通貨対応
   - 国際カード対応
   - 多言語サポート

4. **手数料**
   - 競争力のある料金体系
   - 追加費用なしの基本機能セット

5. **付加機能**
   - 定期支払い
   - マーケットプレイス対応（Connect）
   - カスタム決済フロー

### 実装アプローチ

1. **Elements + Checkout の併用**
   - シンプルな支払いには Stripe Checkout
   - カスタム決済フローには Elements
   - ブランド統一のためのカスタマイズ

2. **サーバーサイド処理**
   - Firebase Functions による安全な決済処理
   - クライアントサイドでの決済情報非保持

3. **Webhook 活用**
   - 非同期イベント処理
   - 決済状態の自動更新

## アーキテクチャ設計

### コンポーネント構成

1. **フロントエンド**
   - PaymentContext: 決済状態の管理
   - PaymentForm: カード情報入力フォーム
   - PaymentMethodSelector: 決済方法選択
   - CheckoutSummary: 決済サマリー表示
   - PaymentHistoryList: 決済履歴一覧
   - ReceiptViewer: 領収書表示

2. **バックエンド (Firebase Functions)**
   - createPaymentIntent: 決済意思の作成
   - confirmPayment: 決済の確定
   - processRefund: 返金処理
   - generateReceipt: 領収書生成
   - handleWebhook: Webhook イベント処理

3. **データモデル**
   - Payment: 決済情報
   - PaymentMethod: 保存された決済方法
   - Transaction: 取引履歴
   - Payout: アテンダーへの支払い情報

### データ構造

```typescript
// 決済情報
interface Payment {
  id: string;
  userId: string;
  bookingId: string;
  amount: number;
  currency: string;
  status: 'pending' | 'processing' | 'succeeded' | 'failed' | 'refunded';
  paymentMethodId: string;
  paymentIntentId: string;
  createdAt: Timestamp;
  updatedAt: Timestamp;
  metadata?: Record<string, any>;
}

// 保存された決済方法
interface PaymentMethod {
  id: string;
  userId: string;
  type: 'card' | 'bank_account' | 'wallet';
  details: {
    brand?: string;
    last4?: string;
    expMonth?: number;
    expYear?: number;
    bankName?: string;
    walletType?: string;
  };
  isDefault: boolean;
  createdAt: Timestamp;
}

// 取引履歴
interface Transaction {
  id: string;
  userId: string;
  type: 'payment' | 'refund' | 'payout';
  amount: number;
  currency: string;
  status: 'pending' | 'completed' | 'failed';
  relatedId: string; // paymentId または payoutId
  description: string;
  createdAt: Timestamp;
}

// アテンダーへの支払い情報
interface Payout {
  id: string;
  attenderId: string;
  amount: number;
  currency: string;
  status: 'pending' | 'processing' | 'paid' | 'failed';
  destinationId: string;
  stripeTransferId?: string;
  createdAt: Timestamp;
  paidAt?: Timestamp;
  bookingIds: string[]; // 関連する予約 ID
}
```

## 実装計画

### フェーズ 1: 基本設定と準備

1. **Stripe アカウント設定**
   - アカウント作成
   - API キーの取得
   - Webhook エンドポイントの設定

2. **Firebase プロジェクト設定**
   - Firebase Functions の有効化
   - Stripe SDK のインストール
   - 環境変数の設定

3. **データモデルの実装**
   - Firestore スキーマ設計
   - セキュリティルールの設定

### フェーズ 2: フロントエンド実装

1. **決済サービスの作成**
   - PaymentService.ts の実装
   - Stripe Elements の統合
   - 決済フォームのバリデーション

2. **決済コンテキストの実装**
   - PaymentContext.tsx の作成
   - 決済状態の管理
   - エラーハンドリング

3. **決済UI コンポーネントの実装**
   - PaymentForm コンポーネント
   - PaymentMethodSelector コンポーネント
   - CheckoutSummary コンポーネント
   - PaymentResult コンポーネント

### フェーズ 3: バックエンド実装

1. **Firebase Functions の設定**
   - Stripe SDK の初期化
   - 認証ミドルウェアの作成

2. **決済処理の実装**
   - createPaymentIntent 関数
   - confirmPayment 関数
   - processRefund 関数

3. **Webhook ハンドラの実装**
   - webhook エンドポイントの作成
   - イベント処理ロジックの実装
   - データベース更新処理

### フェーズ 4: 決済フロー統合

1. **予約フローとの統合**
   - 予約確認画面への決済統合
   - 支払い完了時の予約状態更新

2. **アテンダー報酬システムとの統合**
   - 報酬計算ロジックの実装
   - 出金リクエスト処理の実装

3. **通知システムとの統合**
   - 支払い関連通知の実装
   - 決済状態変更時の通知送信

### フェーズ 5: テストと最適化

1. **テスト環境での検証**
   - テストカードでの決済検証
   - エラーケースのテスト
   - ユーザビリティテスト

2. **セキュリティ強化**
   - 脆弱性チェック
   - データアクセス制限の確認

3. **パフォーマンス最適化**
   - 読み込み時間の改善
   - エラー回復メカニズムの強化

## ファイル構成計画

```
src/
├── services/
│   └── payment/
│       ├── PaymentService.ts            # 決済関連の API 呼び出し
│       ├── StripeService.ts             # Stripe 固有の処理
│       └── PayoutService.ts             # アテンダー報酬関連の処理
│
├── contexts/
│   └── PaymentContext.tsx               # 決済状態の管理
│
├── components/
│   └── payment/
│       ├── index.ts                     # エクスポート
│       ├── PaymentForm.tsx              # 決済情報入力フォーム
│       ├── PaymentMethodSelector.tsx    # 決済方法選択
│       ├── CheckoutSummary.tsx          # 決済サマリー
│       ├── SavedPaymentMethods.tsx      # 保存済み決済方法管理
│       ├── PaymentResult.tsx            # 決済結果表示
│       └── PaymentHistoryList.tsx       # 決済履歴一覧
│
├── types/
│   └── payment.ts                       # 決済関連の型定義
│
└── functions/
    └── src/
        └── payment/
            ├── createPaymentIntent.ts   # 決済意思作成
            ├── confirmPayment.ts        # 決済確定
            ├── handleWebhook.ts         # Webhook 処理
            └── processRefund.ts         # 返金処理
```

## セキュリティ対策

1. **クライアントサイドのセキュリティ**
   - クレジットカード情報の非保持
   - Stripe Elements による安全な情報入力
   - HTTPS 通信の強制

2. **サーバーサイドのセキュリティ**
   - API キーの安全な管理
   - Firebase 認証との連携
   - Webhook 署名の検証

3. **データベースセキュリティ**
   - Firestore セキュリティルールの厳格化
   - 決済情報へのアクセス制限
   - PII（個人を特定できる情報）の最小化

## テスト計画

1. **単体テスト**
   - 各サービス関数のテスト
   - コンポーネントレンダリングテスト

2. **統合テスト**
   - 決済フローの一貫したテスト
   - API 連携の検証

3. **エンドツーエンドテスト**
   - 実際の決済フローのシミュレーション
   - エラーケースのテスト

4. **負荷テスト**
   - 同時複数決済の処理能力テスト
   - 応答時間の計測

## リスク管理

1. **決済失敗時の対応**
   - 自動リトライメカニズム
   - ユーザーへの適切なエラー表示
   - 回復手順の提供

2. **不正利用対策**
   - Stripe Radar の活用
   - 異常な決済パターンの監視
   - 疑わしい取引の手動レビュー

3. **システム障害対策**
   - 決済状態の一貫性確保
   - バックアップと復旧計画
   - 障害通知システム

## 運用計画

1. **モニタリング**
   - 決済成功率の追跡
   - エラー率の監視
   - 処理時間の計測

2. **定期的なレビュー**
   - セキュリティ対策の見直し
   - パフォーマンス最適化
   - ユーザーフィードバックの反映

3. **スケーリング計画**
   - 増加するトランザクション量への対応
   - インフラストラクチャのスケーリング
   - コストの最適化

## 次のステップ

1. **Stripe アカウントの作成と設定**
   - 本番環境と開発環境の API キー取得
   - Webhook エンドポイントの設定

2. **基本的なサービスとモデルの実装**
   - データモデルの作成
   - PaymentService の基本実装

3. **決済フォームと Stripe Elements の統合**
   - 基本的な決済フォームの実装
   - Stripe クライアントサイド SDK の統合

## 完了基準

決済システムの実装は以下の条件が満たされた時点で完了とします：

1. ユーザーが安全に決済情報を入力できる
2. 複数の決済方法が選択できる
3. 決済処理が安定して行える
4. 決済状態が適切に追跡される
5. 決済履歴がユーザーに表示される
6. アテンダーへの報酬支払いが設定できる
7. 返金処理が適切に行える
8. すべてのセキュリティ対策が実装されている
