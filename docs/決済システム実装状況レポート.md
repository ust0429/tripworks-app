# Echo アプリ 決済システム実装状況レポート

## 実装概要

Echo アプリの決済システムの基盤となる部分の実装が完了しました。本レポートでは現在の実装状況と、今後の作業計画について説明します。

## 実装済みコンポーネント

### 1. データモデル

```typescript
// 決済情報
interface Payment {
  id: string;
  userId: string;
  bookingId: string;
  amount: number;
  currency: string;
  status: PaymentStatus;
  paymentMethodId: string;
  paymentIntentId: string;
  createdAt: Timestamp;
  updatedAt: Timestamp;
  metadata?: Record<string, any>;
}

// 支払い方法
interface PaymentMethod {
  id: string;
  userId: string;
  type: PaymentMethodType;
  details: PaymentMethodDetails;
  isDefault: boolean;
  createdAt: Timestamp;
}

// 取引履歴
interface Transaction {
  id: string;
  userId: string;
  type: TransactionType;
  amount: number;
  currency: string;
  status: TransactionStatus;
  relatedId: string;
  description: string;
  createdAt: Timestamp;
}

// アテンダーへの支払い
interface Payout {
  id: string;
  attenderId: string;
  amount: number;
  currency: string;
  status: PayoutStatus;
  destinationId: string;
  stripeTransferId?: string;
  createdAt: Timestamp;
  paidAt?: Timestamp;
  bookingIds: string[];
}
```

### 2. サービス層

以下のサービスを実装し、Firestoreとの連携を行うロジックを集約しました：

1. **PaymentService.ts**
   - ユーザーの支払い処理
   - 支払い方法の管理
   - 取引履歴の取得

2. **StripeService.ts**
   - Stripe API との連携
   - カード情報の処理
   - 決済エラーハンドリング

3. **PayoutService.ts**
   - アテンダーへの支払い処理
   - 支払い履歴の管理
   - 銀行口座情報の管理

### 3. コンテキスト

`PaymentContext.tsx` を実装し、アプリ全体で決済状態を管理できるようにしました：

- 支払い方法の管理
- 支払い履歴の取得
- 決済処理のフロー制御
- エラーハンドリング

### 4. UIコンポーネント

以下の基本UIコンポーネントを実装しました：

1. **PaymentForm**
   - クレジットカード情報入力フォーム
   - カード保存オプション

2. **PaymentMethodSelector**
   - 保存された支払い方法の選択
   - 新しい支払い方法の追加
   - デフォルト設定と削除機能

3. **CheckoutSummary**
   - 決済内容のサマリー表示
   - 小計、税金、サービス料、合計金額の表示

4. **PaymentResult**
   - 決済成功/失敗時の結果表示
   - 次のステップへのナビゲーション

## 今後の実装計画

### 1. Stripe統合の完成

現在の実装は基本的なフレームワークと仮実装を提供していますが、実際のStripe APIとの連携が必要です：

- Stripe Elements の統合
- 本番環境用APIキーの設定
- Webhookエンドポイントの実装

### 2. Firebase Functions の実装

セキュリティを確保するため、以下のサーバーサイド処理をFirebase Functionsに移行：

- `createPaymentIntent` - 決済意思の作成
- `confirmPayment` - 決済の確定
- `handleWebhook` - Webhook イベント処理
- `processRefund` - 返金処理

### 3. 追加UIコンポーネント

以下の追加UIコンポーネントの実装：

- `PaymentHistoryList` - 支払い履歴一覧
- `SavedPaymentMethods` - 保存済み支払い方法管理
- `RefundRequestForm` - 返金リクエストフォーム
- `ReceiptViewer` - 領収書表示

### 4. 予約システムとの統合

予約フローに決済処理を統合：

- 予約確認画面へのCheckoutコンポーネント追加
- 支払い完了時の予約ステータス更新
- 予約キャンセル時の返金処理

## ファイル構成

```
src/
├── types/
│   └── payment.ts                 # 決済関連の型定義
├── services/
│   └── payment/
│       ├── index.ts               # サービスエクスポート
│       ├── PaymentService.ts      # 決済処理サービス
│       ├── StripeService.ts       # Stripe連携サービス
│       └── PayoutService.ts       # 支払い処理サービス
├── contexts/
│   └── PaymentContext.tsx         # 決済状態管理コンテキスト
└── components/
    └── payment/
        ├── index.ts               # コンポーネントエクスポート
        ├── PaymentForm.tsx        # 決済情報入力フォーム
        ├── PaymentMethodSelector.tsx # 支払い方法選択
        ├── CheckoutSummary.tsx    # 決済内容サマリー
        └── PaymentResult.tsx      # 決済結果表示
```

## テスト方法

現在の実装はモックデータを使用しているため、実際の決済処理は行われません。以下の手順でテストできます：

1. `PaymentProvider` をアプリのルートコンポーネントで初期化:

```tsx
// App.tsx
import { PaymentProvider } from './contexts/PaymentContext';

function App() {
  return (
    <AuthProvider>
      <NotificationProvider>
        <PaymentProvider>
          <AppContent />
        </PaymentProvider>
      </NotificationProvider>
    </AuthProvider>
  );
}
```

2. 決済フォームの使用例:

```tsx
import { usePayment } from '../contexts/PaymentContext';
import { PaymentForm, PaymentMethodSelector, CheckoutSummary } from '../components/payment';

const CheckoutScreen = () => {
  const { calculateTotal, processPayment } = usePayment();
  const [selectedPaymentMethodId, setSelectedPaymentMethodId] = useState<string | null>(null);
  const [showNewCardForm, setShowNewCardForm] = useState(false);
  
  // 予約情報
  const booking = {
    id: '123',
    price: 5000
  };
  
  // 合計金額計算
  const summary = calculateTotal(booking.price);
  
  // 支払い処理
  const handlePayment = async () => {
    if (!selectedPaymentMethodId) return;
    
    const result = await processPayment(
      booking.id,
      summary.total,
      selectedPaymentMethodId
    );
    
    if (result.success) {
      // 成功時の処理
    } else {
      // 失敗時の処理
    }
  };
  
  return (
    <div className="max-w-md mx-auto p-4">
      <h1 className="text-2xl font-bold mb-6">お支払い</h1>
      
      <CheckoutSummary summary={summary} />
      
      {showNewCardForm ? (
        <PaymentForm
          onComplete={(paymentMethodId) => {
            setSelectedPaymentMethodId(paymentMethodId);
            setShowNewCardForm(false);
          }}
          onCancel={() => setShowNewCardForm(false)}
        />
      ) : (
        <PaymentMethodSelector
          selectedId={selectedPaymentMethodId || undefined}
          onSelect={setSelectedPaymentMethodId}
          onAddNew={() => setShowNewCardForm(true)}
        />
      )}
      
      <button
        onClick={handlePayment}
        disabled={!selectedPaymentMethodId}
        className="w-full mt-6 py-3 bg-black text-white rounded-lg font-medium disabled:bg-gray-400"
      >
        支払いを確定する
      </button>
    </div>
  );
};
```

## 今後の課題

1. **セキュリティ強化**
   - Firebase Rules の厳格化
   - 敏感なデータの非保持
   - サーバーサイド処理の強化

2. **ユーザビリティ改善**
   - 入力フォームの最適化
   - エラーメッセージの明確化
   - モバイル表示の最適化

3. **テスト環境の整備**
   - テスト用APIキーの設定
   - テストカードによる検証
   - E2Eテストの実装

4. **国際化対応**
   - 複数通貨対応
   - 言語によるメッセージ切り替え
   - 地域に応じた支払い方法の提供

## 次のステップ

1. 開発メンバーによるコードレビュー
2. Stripe API キーの取得と環境変数の設定
3. Firebase Functions の実装
4. インテグレーションテストの実施

以上の実装により、Echo アプリの決済システムの基盤が整いました。今後はStripe APIとの実際の連携を進め、セキュアで使いやすい決済体験を提供していきます。
