# Echo アプリ ファイルアップロード機能実装ガイド

## 概要

ファイルアップロード機能の実装が完了しました。この機能は以下の3つの主要なユースケースに対応しています：

1. **プロフィール画像のアップロード**
2. **レビュー画像のアップロード**
3. **体験関連画像のアップロード**

実装は、フロントエンドとバックエンドの両方で行われ、Firebase Storageをストレージバックエンドとして使用しています。

## 実装内容

### バックエンドAPI

バックエンドでは、以下のAPIエンドポイントを実装しました：

- `POST /api/uploads/profile` - プロフィール画像のアップロード
- `POST /api/uploads/review` - レビュー画像のアップロード
- `POST /api/uploads/experience` - 体験画像のアップロード
- `POST /api/uploads/reviews/multiple` - 複数のレビュー画像をまとめてアップロード
- `POST /api/uploads/experiences/multiple` - 複数の体験画像をまとめてアップロード

各エンドポイントは、認証されたユーザーからのリクエストを受け付け、Firebase Storageにファイルをアップロードします。

### フロントエンドサービス

フロントエンドでは、`FileUploadService.ts`を実装し、以下の機能を提供しています：

- `uploadFile` - バックエンドAPIを使用したファイルアップロード
- `uploadProfileImage` - プロフィール画像のアップロード
- `uploadReviewImage` - レビュー画像のアップロード
- `uploadExperienceImage` - 体験画像のアップロード
- `uploadMultipleImages` - 複数画像の一括アップロード
- ファイルサイズおよびタイプのバリデーション

### コンポーネント

`FileUploader`コンポーネントは、以下の機能を提供するUI要素です：

- ファイル選択のトリガー
- アップロード進捗バーの表示
- アップロード済みファイルのプレビュー
- ファイル削除機能

## ストレージ構造

Firebase Storageでは、以下のディレクトリ構造を使用してファイルを整理しています：

- `/profiles/{userId}/{fileName}` - ユーザープロフィール画像
- `/reviews/{userId}/{fileName}` - レビュー添付画像
- `/experiences/{attenderId}/{fileName}` - 体験関連画像

## Firebase Storageセキュリティルール

Firebase Storageのセキュリティルールは以下のように設定することを推奨します：

```
rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // 認証済みユーザーのみにアクセスを許可
    match /{allPaths=**} {
      allow read: if request.auth != null;
    }
    
    // プロフィール画像のルール
    match /profiles/{userId}/{fileName} {
      // 自分のプロフィール画像のみ書き込み/削除可能
      allow write, delete: if request.auth != null && request.auth.uid == userId;
    }
    
    // レビュー画像のルール
    match /reviews/{userId}/{fileName} {
      // 自分のレビュー画像のみ書き込み/削除可能
      allow write, delete: if request.auth != null && request.auth.uid == userId;
    }
    
    // 体験画像のルール
    match /experiences/{attenderId}/{fileName} {
      // アテンダーIDがFirestoreのattendersコレクションのドキュメントと一致するか確認
      // そのattenderのuserIdが現在のユーザーと一致するか確認
      allow write, delete: if request.auth != null && existsAfter(/databases/(default)/documents/attenders/$(attenderId)) && get(/databases/(default)/documents/attenders/$(attenderId)).data.userId == request.auth.uid;
    }
  }
}
```

これらのルールは、以下の原則に基づいています：

1. 認証されたユーザーのみがファイルを閲覧可能
2. ユーザーは自分のプロフィール画像とレビュー画像のみを書き込み/削除可能
3. アテンダーは自分の体験画像のみを書き込み/削除可能

## 使用方法

### 基本的な使用方法

```tsx
import { FileUploader } from 'src/components/common/FileUploader';
import { useAuth } from 'src/hooks/useAuth';

const ProfileEditPage = () => {
  const { user } = useAuth();
  const userId = user?.uid;

  const handleFileUploaded = (urls: string[]) => {
    // アップロードされたファイルのURLを処理
    const profileImageUrl = urls[0];
    // ...
  };

  return (
    <div>
      <h2>プロフィール画像を変更</h2>
      {userId && (
        <FileUploader
          onFileUploaded={handleFileUploaded}
          userId={userId}
          uploadType="profile"
          multiple={false}
        />
      )}
    </div>
  );
};
```

### 複数ファイルのアップロード

```tsx
<FileUploader
  onFileUploaded={handleImagesUploaded}
  userId={userId}
  uploadType="review"
  multiple={true}
  maxFiles={5}
  existingFiles={existingImageUrls}
/>
```

## 留意事項

### パフォーマンスと制限

1. **ファイルサイズ制限**: 現在の実装では、ファイルサイズを10MB以下に制限しています。
2. **ファイルタイプ制限**: JPEG、PNG、GIF形式の画像のみをサポートしています。
3. **アップロード数制限**: 一度に複数のファイルをアップロードする場合、レビュー画像は最大5枚、体験画像は最大10枚までに制限されています。

### エラーハンドリング

`FileUploadService`はさまざまなエラーケースを処理し、以下のような構造化されたエラー情報を返します：

```typescript
{
  success: false,
  error: {
    code: 'ERROR_CODE',
    message: 'エラーメッセージ'
  }
}
```

主なエラーコードは以下の通りです：

- `FILE_TOO_LARGE` - ファイルサイズが制限を超えている
- `INVALID_FILE_TYPE` - サポートされていないファイル形式
- `UPLOAD_ERROR` - アップロード中のエラー
- `MULTIPLE_UPLOAD_ERROR` - 複数ファイルアップロード中のエラー

### セキュリティ上の注意事項

1. クライアント側のバリデーションだけでなく、サーバー側でも必ずバリデーションを行う。
2. Firebase Storageのセキュリティルールを適切に設定する。
3. ファイルのメタデータを確認し、MIMEタイプなどが期待通りであることを確認する。
4. アップロードされたファイルの公開URLは安全に保存し、権限のないユーザーがアクセスできないようにする。

## 今後の改善点

1. **画像の最適化**: 画像のリサイズや圧縮を実装して、ストレージとネットワーク帯域幅を節約する。
2. **画像メタデータ**: EXIF情報などのセンシティブなメタデータを削除する機能の追加。
3. **CDN統合**: Firebase Storage URLをCDNと統合して、配信パフォーマンスを向上させる。
4. **オフライン対応**: オフライン時にもファイルをキューに入れてアップロードできるようにする。
5. **ドラッグ&ドロップ対応**: FileUploaderコンポーネントにドラッグ&ドロップ機能を追加する。

## 参考リソース

1. [Firebase Storage ドキュメント](https://firebase.google.com/docs/storage)
2. [Firebase Storageセキュリティルール](https://firebase.google.com/docs/storage/security)
3. [Multer NPMパッケージ](https://www.npmjs.com/package/multer)
