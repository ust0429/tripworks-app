# Echo アプリ バックエンド統合実装ガイド

このガイドでは、バックエンド統合のための実装手順と注意点を説明します。

## 1. 実装したファイル

今回の実装で追加した主要なファイルは以下の通りです：

1. **services/BookingService.ts**
   - 予約関連の機能を集約したサービス
   - 予約の作成、取得、更新、キャンセル、確定などの機能を提供

2. **services/ReviewService.ts**
   - レビュー関連の機能を集約したサービス
   - レビューの投稿、取得、編集、削除、「役に立った」マーキングなどの機能を提供

3. **utils/apiClientEnhanced.ts**
   - Firebase Authentication統合機能付きAPIクライアント
   - 認証トークンを自動的にAPIリクエストヘッダーに追加
   - トークンキャッシュ機能とリフレッシュ機能を実装

4. **echo-backend/src/middleware/authMiddleware.ts**
   - バックエンド側でのFirebase認証ミドルウェア
   - トークン検証、ロールベースアクセス制御、アテンダー検証などの機能を提供

## 2. 統合手順

### 2.1 フロントエンド側の統合

1. **既存のAPIクライアントを認証対応版に置き換える**

```typescript
// utils/apiClient.ts を置き換えるか、apiClientEnhanced.ts を新たにインポートして使用
import apiClient from '../utils/apiClientEnhanced';
```

2. **サービスの登録**

新しく実装した `BookingService` と `ReviewService` をプロジェクトに統合します。

```typescript
// サービスを必要な場所でインポート
import { getUserBookings, createBooking } from '../services/BookingService';
import { getAttenderReviews, createReview } from '../services/ReviewService';
```

3. **認証フローの統合**

ログイン/ログアウト時にトークンキャッシュをクリアするようにします。これは `apiClientEnhanced.ts` 内の `setupAuthListener` で自動的に設定されています。

### 2.2 バックエンド側の統合

1. **認証ミドルウェアの統合**

```typescript
// echo-backend/src/routes/index.ts 内で認証ミドルウェアを統合
import { verifyAuth, requireRoles, verifyAttender } from '../middleware/authMiddleware';

// 認証が必要なルートに適用
router.use('/attenders', verifyAuth);
router.use('/bookings', verifyAuth);
router.use('/reviews', verifyAuth);

// 特定のエンドポイントに役割制限を適用
router.use('/admin', verifyAuth, requireRoles(['admin']));

// アテンダー専用ルートに検証を適用
router.use('/attenders/:id/experiences', verifyAuth, verifyAttender);
```

2. **APIルートでのユーザー情報の活用**

```typescript
// echo-backend/src/routes/bookings.ts
import { AuthenticatedRequest } from '../middleware/authMiddleware';

router.post('/', async (req: AuthenticatedRequest, res) => {
  try {
    const userId = req.user?.uid;
    
    if (!userId) {
      return res.status(401).json({ error: 'User ID is required' });
    }
    
    // リクエストデータにユーザーIDを追加
    const bookingData = {
      ...req.body,
      userId
    };
    
    // 以降は既存の処理
  } catch (error) {
    // エラーハンドリング
  }
});
```

## 3. 主要なデータフロー

### 3.1 予約作成プロセス

1. ユーザーが予約フォームを送信
2. `BookingService.createBooking()` がフォームデータを受け取る
3. Firebase Authentication から現在のユーザーIDを取得
4. バックエンドAPIにデータを送信（認証トークン付き）
5. バックエンドでトークンを検証し、ユーザーIDを確認
6. Firestoreに予約データを保存
7. 関連するユーザーへの通知を作成
8. 成功レスポンスをフロントエンドに返す

### 3.2 レビュー投稿プロセス

1. ユーザーがレビューフォームを送信
2. `ReviewService.createReview()` がフォームデータを受け取る
3. Firebase Authentication から現在のユーザーIDを取得
4. バックエンドAPIにデータを送信（認証トークン付き）
5. バックエンドでトークンを検証し、ユーザーIDを確認
6. Firestoreにレビューデータを保存
7. アテンダーの評価平均を更新
8. 成功レスポンスをフロントエンドに返す

## 4. 認証データフロー

1. ユーザーがログイン
2. Firebase Authentication からIDトークンを取得
3. `apiClientEnhanced.ts` がトークンをキャッシュし、リクエストヘッダーに追加
4. バックエンドAPIがリクエストを受信
5. `authMiddleware.ts` がトークンを検証
6. 検証成功時、リクエストオブジェクトにユーザー情報を追加
7. APIハンドラーが処理を続行

## 5. 注意点とベストプラクティス

### 5.1 セキュリティ

- 認証トークンは常にHTTPS接続で送信する
- Firebaseのセキュリティルールを適切に設定する
- バックエンド側でもユーザーIDの所有権を検証する（自分のリソースのみアクセス可能に）

### 5.2 エラーハンドリング

- トークン期限切れやネットワークエラーに対する適切な処理
- ユーザーフレンドリーなエラーメッセージの表示
- 開発環境での詳細なログ出力

### 5.3 パフォーマンス

- トークンキャッシュを活用して不要なリクエストを減らす
- 大きなデータセットには適切なページネーションを実装
- レスポンスのキャッシュ戦略を検討

## 6. 次のステップ

1. **体験機能（Experience）の実装**
   - 体験の作成、検索、予約フローの完全実装

2. **通知システムの統合**
   - リアルタイム通知とプッシュ通知の実装

3. **決済システムの統合**
   - 予約時の決済処理フローの実装

4. **管理者機能の実装**
   - 管理者向けダッシュボードとコントロール機能

5. **テスト計画の策定**
   - 単体テスト、統合テスト、エンドツーエンドテストの実装

## 7. テスト方法

1. **認証テスト**
   - ログイン後のトークン取得テスト
   - 認証ヘッダー付きリクエストのテスト
   - 権限不足時のエラー処理テスト

2. **予約テスト**
   - 予約作成の成功シナリオ
   - バリデーションエラーのテスト
   - 予約状態変更のテスト（確定、キャンセル、完了）

3. **レビューテスト**
   - レビュー投稿の成功シナリオ
   - レビュー編集・削除のテスト
   - 「役に立った」機能のテスト

各テストは開発環境でモックデータを使用して実行可能です。本番環境前にはFirebase Emulatorを使用した統合テストを行うことをお勧めします。
